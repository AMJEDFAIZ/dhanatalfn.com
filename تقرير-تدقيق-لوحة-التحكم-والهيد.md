# تقرير تدقيق لوحة التحكم وقسم الهيد (site.blade.php)

## 1. نظرة عامة

هذا التقرير يغطي:
- **لوحة التحكم (Admin)**: جميع الواجهات والمجلدات (admin, blog, gallery, keywords, layouts, messages, partials, projects, seo-pages, services, settings, skills, testimonials) من حيث البيانات، الحقول، الأداء، الأمان، التصميم، الأخطاء ونقاط الضعف والتحسينات.
- **قسم الهيد في `resources/views/layouts/site.blade.php` (السطور 3–326)**: التحقق من عمله مع كل أنواع الصفحات وبيانات كل صفحة (عناوين، أوصاف، كلمات مفتاحية، صور، OG، Schema).

---

# الجزء الأول: لوحة التحكم (Admin)

## 1.1 هيكل المجلدات والواجهات

| المجلد / الملف | الوظيفة | البيانات الممرّرة من الكنترولر |
|----------------|---------|--------------------------------|
| **layouts/admin.blade.php** | Layout رئيسي للوحة التحكم | `$settings` (عبر View Composer)، `$unreadMessagesCount` (عبر View Composer) |
| **dashboard.blade.php** | لوحة الإحصائيات | `$counts`, `$percentages`, `$latest`, `$previews`, `$messageCounts`, `$unreadMessages` |
| **services/** (index, create, edit) | إدارة الخدمات | index: `$services` (paginate). create: `$projects`, `$keywords`. edit: `$service`, `$projects`, `$keywords`, `$metaKeywordIds`, `$contentKeywordIds`, `$keywordPrimaryIds`, `$keywordWeights`, `$service->allFaqs` |
| **projects/** (index, create, edit) | إدارة المشاريع | index: `$projects` (with service). create: `$services`, `$keywords`. edit: `$project`, `$services`, `$keywords` + نفس مصفوفات الكلمات، `$project->allFaqs` |
| **gallery/** (index, create, edit) | معرض الصور | index: `$images` (with project). create: `$projects`. edit: `$image`, `$projects` |
| **blog/** (index, create, edit) | المدونة | index: `$posts`. create/edit: `$blog`, `$keywords` + مصفوفات كلمات، `$blog->faqs` |
| **keywords/** (index, create, edit, show) | الكلمات المفتاحية | index: `$keywords` (paginate). create: لا بيانات إضافية. edit: `$keyword`, مصفوفات الربط. show: `$keyword` + عناصر مرتبطة |
| **seo-pages/** (index, edit) | كلمات الصفحات | index: `$pages`. edit: `$seoPage`, `$keywords` + مصفوفات |
| **testimonials/** (index, create, edit) | آراء العملاء | index: `$testimonials`. create/edit: `$testimonial` |
| **skills/** (index, create, edit) | المهارات | index: `$skills`. create/edit: `$skill` |
| **messages/** (index, show) | الرسائل | index: `$messages` + فلترة. show: `$message` |
| **settings/index.blade.php** | الإعدادات العامة | `$settings` (key-value) |
| **partials/keywords-fields.blade.php** | حقول الكلمات المفتاحية (مشترك) | `$keywords`, `$metaKeywordIds`, `$contentKeywordIds`, `$keywordPrimaryIds`, `$keywordWeights` |

## 1.2 الأداء

### نقاط القوة
- استخدام **Pagination** في القوائم (الخدمات، المشاريع، المدونة، الكلمات المفتاحية، الرسائل، المعرض، المهارات، آراء العملاء).
- **Eager Loading**: `Project::with('service')` في قائمة المشاريع، `GalleryImage::with('project')` في المعرض، تحميل `allFaqs` و`keywords` في شاشات التعديل عند الحاجة.
- **كاش الإعدادات**: `$settings` تُحمّل من الكاش عبر View Composer.
- **كاش عداد الرسائل غير المقروءة**: 60 ثانية لتقليل استعلامات قاعدة البيانات.

### نقاط تحتاج تحسين
- **Dashboard**: يتم تنفيذ عدة استعلامات منفصلة (`$counts`, `$latest`, `$previews`, `$messageCounts`, `$unreadMessages`). يمكن دمج بعضها أو استخدام كاش قصير للـ previews.
- **قائمة الخدمات (admin)**: لا يتم تحميل علاقة `projects` أو `withCount('projects')`؛ إذا أضيف عمود "عدد المشاريع" لاحقاً يفضّل إضافة `withCount('projects')` لتجنب N+1.

## 1.3 الأمان

### نقاط القوة
- جميع مسارات لوحة التحكم محمية بـ **middleware** `auth` و`verified`.
- جميع النماذج (Forms) تحتوي على **@csrf**.
- استخدام **@method('PUT'/'DELETE')** حيث يلزم.
- **Validation** في الكنترولرز على المدخلات (عنوان، slug، ملفات، مصفوفات الكلمات، إلخ).
- **Throttling** على مسار الرد على الرسائل `messages.reply` (10 طلبات/دقيقة).

### توصيات
- التأكد من أن صلاحيات الحذف والتعديل لا تتجاوز ملكية المورد إن وُجد نظام صلاحيات لاحقاً.
- عدم تمرير أخطاء قاعدة البيانات أو الاستثناءات مباشرة للمستخدم؛ الاعتماد على رسائل عامة بعد تسجيل الخطأ.

## 1.4 التصميم وتجربة الاستخدام

### نقاط القوة
- **Layout موحّد** (شريط علوي، شريط جانبي، Breadcrumbs، منطقة محتوى).
- **تصميم متجاوب**: Sidebar يتحول إلى Offcanvas على الشاشات الصغيرة.
- استخدام **Bootstrap 5** وأيقونات واضحة.
- عرض رسائل النجاح والخطأ بشكل موحّد.
- عرض أخطاء التحقق `@error` و`$errors->any()` في النماذج.

### نقاط ضعف / ملاحظات
- **Breadcrumbs**: لا تُعرّف في كل الصفحات (مثل create/edit لمعظم الموارد)؛ يظهر فقط "لوحة التحكم" ثم @yield('breadcrumbs') الفارغ في كثير من الشاشات.
- **روابط المعاينة**: في Dashboard، روابط "معاينة" تفتح في تاب جديد لصفحات الموقع (services.show, projects.show, blog.show) وهي سليمة.
- **تنبيه تسجيل الدخول**: يظهر دائماً في أعلى لوحة التحكم؛ يمكن إخفاؤه بعد أول تفاعل أو جعله قابلاً للإغلاق فقط (موجود حالياً).

## 1.5 أخطاء ونقاط ضعف محتملة

### 1. لوحة التحكم – معرض الصور (previews)
- **الملف**: `admin/dashboard.blade.php` (قسم المعرض في `$previews['gallery']`).
- **المشكلة**: استخدام `asset($item->image_path ? 'storage/'.$item->image_path : 'placeholder.png')` — الملف `placeholder.png` قد لا يكون موجوداً في الجذر، مما ينتج رابطاً مكسوراً.
- **التوصية**: استخدام مسار ثابت معروف مثل `asset('assets/img/placeholder.png')` أو التحقق من وجود الملف، أو عرض أيقونة بدلاً من صورة عند غياب `image_path`.

### 2. رابط Favicon في layout لوحة التحكم
- **الملف**: `admin/layouts/admin.blade.php`.
- **الملف الحالي**: `@if (isset($settings['site_favicon']))` ثم `href="{{ asset('storage/' . $settings['site_favicon']) ?? asset('favicon.ico') }}"`.
- **ملاحظة**: التعبير `?? asset('favicon.ico')` لن يُستخدم عملياً لأن `asset('storage/...')` غالباً يرجع نصاً غير فارغ؛ السلوك صحيح، لكن من الواضح أن الـ else (عند عدم وجود favicon) يعتمد على عدم عرض الوسم أصلاً. التأكد من وجود `favicon.ico` في `public` للصفحات التي لا تمرّر فيها الإعدادات.

### 3. صفحة الإعدادات – طريقة الإرسال
- **الملف**: `admin/settings/index.blade.php`.
- **الملاحظة**: النموذج يستخدم `method="POST"` مع `@method('PUT')` و`action="{{ route('admin.settings.update') }}"` — متوافق مع المسار المعرّف كـ PUT في web.php.

### 4. صفحة الرسائل (messages index)
- **الملاحظة**: وجود فلترة حسب الحالة (مقروء/غير مقروء) وربما حسب الموضوع؛ التأكد من أن الكنترولر يمرّر المتغيرات المطلوبة للـ view (مثل `$messages` مع pagination و/أو `status`).

## 1.6 التحسينات المقترحة

1. **إضافة Breadcrumbs** لصفحات create/edit (مثال: لوحة التحكم > الخدمات > تعديل الخدمة).
2. **توحيد عرض الأخطاء**: استخدام مكوّن أو partial واحد لـ `$errors->any()` في كل النماذج.
3. **تصحيح رابط الصورة الافتراضية** في معرض لوحة التحكم كما في الفقرة 1.5.
4. **تحسين أداء Dashboard** (اختياري): كاش لـ `$previews` أو `$latest` لمدة دقائق قليلة.
5. **عرض عمود "الخدمة"** في جدول المشاريع (admin) باستخدام `$project->service->title` مع وجود Eager Loading مسبقاً.

---

# الجزء الثاني: قسم الهيد في site.blade.php (السطور 3–326)

## 2.1 الغرض من القسم

قسم الـ `<head>` مسؤول عن:
- **العنوان والوصف والكلمات المفتاحية** (للمحركات والمشاركة).
- **Robots و Canonical و hreflang**.
- **Open Graph و Twitter Cards** (عناوين، أوصاف، صور، نوع المحتوى).
- **وسوم المقال** (article:published_time, article:modified_time, article:tag) لصفحات التفاصيل.
- **ربط Schema.org** عبر `@include('partials.schema')`.

## 2.2 مصدر البيانات حسب نوع الصفحة

يتم تجميع القيم من:
1. **متغيرات يمرّرها الكنترولر**: `$meta_title`, `$meta_description`, `$meta_keywords`, `$contentKeywords`, `$pageContentKeywords`, `$robots_noindex`, `$meta_image`.
2. **Sections من الـ view الفرعي**: `@section('title')`, `@section('meta_title')`, `@section('meta_description')`, `@section('meta_keywords')`, `@section('meta_image')`.
3. **إعدادات عامة**: `$settings` (من View Composer) مثل `site_name`, `site_description`, `site_logo`, `site_favicon`, `site_author`.
4. **نموذج الصفحة (إن وُجد)**: `$post`, `$service`, `$project` لاستخراج الصورة وتواريخ المقال ووسوم المحتوى.

### تطابق البيانات مع أنواع الصفحات

| نوع الصفحة | Route | مصدر العنوان | مصدر الوصف | مصدر الكلمات | مصدر الصورة OG |
|------------|-------|--------------|------------|--------------|-----------------|
| الرئيسية | home | Controller: `$meta_title` (site_name) | Controller: `$meta_description` | Controller + SeoPage + contentKeywords | شعار الموقع |
| من نحن | about | Settings: about_meta_title | Settings: about_meta_description | SeoPage + pageContentKeywords | شعار الموقع |
| اتصل بنا | contact | Settings: contact_meta_title | Settings: contact_meta_description | SeoPage + pageContentKeywords | شعار الموقع |
| قائمة الخدمات | services.index | Settings: services_meta_* | نفس | SeoPage + pageContentKeywords | شعار الموقع |
| تفاصيل خدمة | services.show | Controller: SeoMetaService أو view section | نفس | Controller: meta_keywords + contentKeywords | خدمة: image_path أو شعار |
| قائمة المشاريع | projects.index | Settings: projects_meta_* | نفس | SeoPage + pageContentKeywords | شعار الموقع |
| تفاصيل مشروع | projects.show | Controller + view section | نفس | Controller + contentKeywords | مشروع: main_image أو شعار |
| قائمة المدونة | blog.index | Settings: blog_meta_* (مع دعم search) | نفس | SeoPage + مصطلح البحث إن وُجد | شعار الموقع |
| تفاصيل مقال | blog.show | Controller + post | نفس | Controller + contentKeywords | مقال: image_path أو شعار |
| صفحة كلمة مفتاحية | keywords.show | Controller: اسم الكلمة | Controller: وصف الكلمة | اسم الكلمة | شعار الموقع |

الخلاصة: **مصادر البيانات متوافقة مع أنواع الصفحات**؛ الكنترولرز تمرّر القيم المناسبة والـ layout يوفّر أولوية واضحة (متغير من الكنترولر ثم الـ section ثم الإعدادات/الشعار).

## 2.3 منطق العنوان والوصف والكلمات

- **العنوان**:  
  `$resolvedMetaTitle = $meta_title ?? sectionMetaTitle ?? sectionTitle ?? null`  
  ثم `<title>` إمّا `resolvedMetaTitle | site_name` أو `site_name | resolvedPageTitle/الصفحة الرئيسية`. **سليم**.

- **الوصف**:  
  يُنظّف من HTML ويُقصّر إلى 160 حرفاً عند الإخراج. **متوافق مع أفضل الممارسات**.

- **الكلمات المفتاحية**:  
  من `$meta_keywords` (نص أو مصفوفة) أو من الـ section، وإذا كانت فارغة يُستنتج من `$contentKeywords` و`$pageContentKeywords` (جمع أسماء الكلمات). **يعمل مع كل الصفحات التي تمرّر فيها هذه المتغيرات**.

## 2.4 Robots و Canonical

- **Robots**:  
  افتراضي `index,follow` مع خيارات max-snippet؛ تحويل إلى `noindex,follow` لصفحة بحث المدونة (`blog.index` + `search`) وللصفحات التي يمرّر فيها `$robots_noindex`. **صحيح**.

- **Canonical**:  
  يُبنى من `url()->current()` مع السماح فقط ببارامتر `page` (للترقيم). **مناسب**.

- **hreflang**:  
  `ar-SA` و`x-default` على الـ canonical. **مناسب لموقع عربي واحد**.

## 2.5 Open Graph و Twitter

- **og:type**:  
  `article` لـ `blog.show`, `services.show`, `projects.show`؛ `website` لباقي الصفحات. **صحيح**.

- **article:published_time / article:modified_time**:  
  تُستخرج من `$post`, `$service`, أو `$project` عند وجود `$articleModel`. **يعمل** لأن الكنترولرز تمرّر هذه النماذج.

- **الصورة**:  
  الأولوية: `$meta_image` أو section، ثم صورة النموذج (post/service/project)، ثم شعار الموقع. تحويل المسارات النسبية إلى مطلقة (url/asset). **يعمل مع كل أنواع الصفحات**.

- **Twitter**:  
  نفس العنوان والوصف والصورة مع `summary_large_image`. **متوافق**.

## 2.6 ملاحظات تقنية على الكود

1. **استدعاء routeIs**:  
   السطر 110 يستخدم `request()->routeIs('blog.show', 'services.show', 'projects.show')`. في Laravel يمكن تمرير أسماء متعددة؛ السلوك هو "أي واحد من هذه"، وهو **صحيح**.

2. **نشر_at للخدمة والمشروع**:  
   الخدمة والمشروع لا يملكان حقل `published_at`؛ الكود يستخدم `$articleModel->published_at ?? $articleModel->created_at`، فيُستخدم `created_at` تلقائياً. **لا خطأ**.

3. **محتوى الـ head والـ Schema**:  
   `@include('partials.schema')` يعتمد على نفس المتغيرات (`$meta_title`, `$meta_description`, `$contentKeywords`, `$service`, `$project`, `$post`, إلخ). بما أن الـ layout يُنفّذ بعد تحميل الـ view الفرعي، فجميع المتغيرات الممرّة من الكنترولر متوفرة في الـ schema. **متوافق**.

4. **Preload للصورة على الرئيسية**:  
   السطور 253–256 تستخدم `rel="preload" as="image"` مع `imagesrcset` و`imagesizes` — السمة الصحيحة في HTML هي `imagesrcset` (بدون مسافة)، وقد لا تدعمها كل المتصفحات؛ الـ preload العادي بـ `href` فقط مدعوم بشكل أوسع. **تحسين اختياري**: الاكتفاء بـ `href` للصورة الأكثر استخداماً.

5. **رابط Sitemap**:  
   `<link rel="sitemap" type="application/xml" href="{{ asset('sitemap.xml') }}">` — غير شائع لكنه لا يسبب خطأ؛ محركات البحث تعتمد عادة على `robots.txt` وروابط Sitemap فيه. **لا مشكلة**.

## 2.7 خلاصة قسم الهيد

- **يعمل بشكل صحيح** مع الصفحات الرئيسية، من نحن، اتصل بنا، قوائم الخدمات/المشاريع/المدونة، تفاصيل الخدمة/المشروع/المقال، وصفحة الكلمة المفتاحية.
- **البيانات تظهر بحسب نوع الصفحة**: عناوين، أوصاف، كلمات مفتاحية، صور OG، ووسوم المقال حيث يلزم.
- **لا تناقض** بين ما يمرّره كل كنترولر وما يتوقعه الـ layout والـ schema؛ الإعدادات العامة والـ View Composer يوفّران `$settings` لكل الصفحات.

---

# الجزء الثالث: ملخص التوصيات والإجراءات

## لوحة التحكم

| # | التوصية | الأولوية |
|---|---------|----------|
| 1 | تصحيح رابط الصورة الافتراضية في معرض لوحة التحكم (dashboard – gallery preview) | عالية |
| 2 | إضافة Breadcrumbs لصفحات create/edit | متوسطة |
| 3 | تحسين أداء Dashboard (كاش للـ previews/latest) | منخفضة |
| 4 | إضافة عمود "الخدمة" في جدول المشاريع مع الاستمرار باستخدام with('service') | منخفضة |

## قسم الهيد (site.blade.php)

| # | التوصية | الأولوية |
|---|---------|----------|
| 1 | مراجعة preload صورة الهيرو على الرئيسية (تبسيط استخدام imagesrcset إن لزم) | منخفضة |
| 2 | لا يلزم تغيير في منطق البيانات؛ المنطق الحالي متوافق مع كل أنواع الصفحات | — |

---

تم إعداد التقرير بناءً على فحص ملفات المشروع ومسارات الواجهات والكنترولرز. يُنصح بتنفيذ التوصية ذات الأولوية العالية (رابط الصورة الافتراضية في لوحة التحكم) ثم باقي التحسينات حسب الأولوية.
